#!/bin/bash
#################################################
# WeMessage 2020 - thormster                    #
# Programme d'envoi de SMS basé sur KDE Connect #
# Version 2.0                                   #
# Optimisé pour KDE                             #
#################################################

# TODO
#   - Pouvoir modifier/ajouter/supprimer un contact à tout moment
#   - Renvoyer un sms
#   - Pouvoir log les échanges sms
#   - check multi sms
#   - check pair || faire le pairing

device=YOUR_ID_DEVICE
CONTACT_FILE="./contacts"

title="WeMessage - Envoi de SMS"

## RECUPERER ID DEVICE kdeconnect-cli -a

# welcome
kdialog --title "$title" --geometry=250x250 --msgbox "Bienvenue sur WeMessage !"

# Fichier de contacts
if [ -e $CONTACT_FILE ];
then
    i=1
    while read -r aLine;
    do
        listProgs[$i]="$aLine";
        ((i++));
    done < $CONTACT_FILE
else
    answer=$(kdialog --title "$title" --geometry=300x100+800+500 --yesno "J'ai vu que tu n'avais pas de fichier de contact. Pour te simplifier tes envois, souhaites tu en créer un ?")
    if [ $? -eq 0 ]
    then
        echo -n > $CONTACT_FILE
        name=$(kdialog --title "$title" --geometry=300x100+800+500 --textinputbox "Nom de votre contact :")
        num=$(kdialog --title "$title" --geometry=300x100+800+500 --textinputbox "Numéro de téléphone :")
        echo "$name-$num" > $CONTACT_FILE
        echo -e >> $CONTACT_FILE
        kdialog --title "$title" --geometry=300x100+800+500 --msgbox "Fichier de contact mis à jour. Si tu veux ajouter un autre contact, redemarre le programme"
        exit
    else
        dest=$(kdialog --title "$title" --geometry=300x100+800+500 --textinputbox "Numéro de votre contact :")
        message=$(kdialog --title "$title" --geometry=300x100+800+500 --textinputbox "Et le message :")
        kdeconnect-cli --destination "$dest" --device "$device" --send-sms "$message"
        kdialog --title "$title" --geometry=200 --msgbox "Message envoyé !"
        exit
    fi
fi

#echo "${listProgs[@]}"## == AFFICHE TOUT LE TABLEAU

#CHOIX DU CONTACT
tmp=$(kdialog --title "$title" --geometry=300x100+800+500 --combobox "Choisis ton contact :" "${listProgs[@]}")
if [ "$tmp" = "" ]
then
    kdialog --title "$title" --geometry=300x100+800+500 --error "Tu dois choisir un contact"
    exit
else
    dest=$(expr "$tmp" : "[^0-9]*\([0-9]*\)")
    message=$(kdialog --title "$title" --geometry=250x50+800+500 --textinputbox "Ecris ici ;)")
    if [ "$message" = "" ]
    then
        kdialog --title "$title" --geometry=250x250+800+500 --error "Tu n'as rien tappé.. Tu fais comme tu veux mais bon.. si c'est pour me déranger pour rien.."
        exit
    else
        kdeconnect-cli --destination "$dest" --device "$device" --send-sms "$message"
        kdialog --title "$title" --geometry=200 --msgbox "Message envoyé !"
    fi
fi
